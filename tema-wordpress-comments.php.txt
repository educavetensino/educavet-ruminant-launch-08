<?php
/**
 * Template para comentários
 */

if (post_password_required()) {
    return;
}
?>

<div id="comments" class="comments-area">
    
    <?php if (have_comments()) : ?>
        <h3 class="comments-title">
            <?php
            $comment_count = get_comments_number();
            if ($comment_count == 1) {
                echo '1 Comentário';
            } else {
                printf('%s Comentários', number_format_i18n($comment_count));
            }
            ?>
        </h3>

        <ol class="comment-list">
            <?php
            wp_list_comments(array(
                'style'       => 'ol',
                'short_ping'  => true,
                'avatar_size' => 60,
                'callback'    => 'tema_custom_comment',
            ));
            ?>
        </ol>

        <?php if (get_comment_pages_count() > 1 && get_option('page_comments')) : ?>
            <nav class="comment-navigation">
                <div class="nav-links">
                    <?php
                    if ($prev_link = get_previous_comments_link('Comentários Anteriores')) {
                        echo '<div class="nav-previous">' . $prev_link . '</div>';
                    }
                    if ($next_link = get_next_comments_link('Próximos Comentários')) {
                        echo '<div class="nav-next">' . $next_link . '</div>';
                    }
                    ?>
                </div>
            </nav>
        <?php endif; ?>

    <?php endif; ?>

    <?php if (!comments_open() && get_comments_number() && post_type_supports(get_post_type(), 'comments')) : ?>
        <p class="no-comments">Os comentários estão fechados.</p>
    <?php endif; ?>

    <?php
    comment_form(array(
        'title_reply'          => 'Deixe um comentário',
        'title_reply_to'       => 'Responder para %s',
        'cancel_reply_link'    => 'Cancelar resposta',
        'label_submit'         => 'Enviar Comentário',
        'submit_button'        => '<input name="%1$s" type="submit" id="%2$s" class="%3$s btn btn-primary" value="%4$s" />',
        'comment_field'        => '<div class="form-group"><label for="comment">Comentário *</label><textarea id="comment" name="comment" class="form-input" rows="6" required></textarea></div>',
        'fields'               => array(
            'author' => '<div class="form-row"><div class="form-group"><label for="author">Nome *</label><input id="author" name="author" type="text" class="form-input" required /></div>',
            'email'  => '<div class="form-group"><label for="email">Email *</label><input id="email" name="email" type="email" class="form-input" required /></div>',
            'url'    => '<div class="form-group"><label for="url">Website</label><input id="url" name="url" type="url" class="form-input" /></div></div>',
        ),
    ));
    ?>

</div><!-- #comments -->

<?php
/**
 * Callback personalizado para comentários
 */
function tema_custom_comment($comment, $args, $depth) {
    $GLOBALS['comment'] = $comment;
    ?>
    <li <?php comment_class('comment-item'); ?> id="comment-<?php comment_ID(); ?>">
        <article class="comment-body">
            <footer class="comment-meta">
                <div class="comment-author vcard">
                    <?php echo get_avatar($comment, 60, '', '', array('class' => 'avatar')); ?>
                    <div class="comment-metadata">
                        <cite class="fn"><?php comment_author_link(); ?></cite>
                        <div class="comment-date">
                            <a href="<?php echo esc_url(get_comment_link($comment->comment_ID)); ?>">
                                <time datetime="<?php comment_time('c'); ?>">
                                    <?php comment_date('j M Y'); ?> às <?php comment_time('H:i'); ?>
                                </time>
                            </a>
                        </div>
                    </div>
                </div>

                <?php if ($comment->comment_approved == '0') : ?>
                    <em class="comment-awaiting-moderation">Seu comentário está aguardando moderação.</em>
                <?php endif; ?>
            </footer>

            <div class="comment-content">
                <?php comment_text(); ?>
            </div>

            <div class="comment-actions">
                <?php
                comment_reply_link(array_merge($args, array(
                    'add_below' => 'comment',
                    'depth'     => $depth,
                    'max_depth' => $args['max_depth'],
                    'before'    => '<div class="reply">',
                    'after'     => '</div>',
                )));
                ?>
                
                <?php edit_comment_link('Editar', '<span class="edit-link">', '</span>'); ?>
            </div>
        </article>
    <?php
}
?>

<style>
/* Estilos para comentários */
.comments-area {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--cor-borda);
}

.comments-title {
    color: var(--cor-texto);
    font-size: 1.5rem;
    margin-bottom: 2rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--cor-primaria);
}

.comment-list {
    list-style: none;
    margin: 0 0 2rem 0;
    padding: 0;
}

.comment-item {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: var(--cor-fundo);
    border: 1px solid var(--cor-borda);
    border-radius: 8px;
}

.comment-item .comment-item {
    margin-left: 2rem;
    margin-top: 1rem;
    border-left: 3px solid var(--cor-primaria);
    background: var(--cor-fundo-claro);
}

.comment-meta {
    margin-bottom: 1rem;
}

.comment-author {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.comment-author .avatar {
    border-radius: 50%;
    flex-shrink: 0;
}

.comment-metadata {
    flex: 1;
}

.comment-author .fn {
    font-style: normal;
    font-weight: 600;
    color: var(--cor-texto);
    text-decoration: none;
}

.comment-author .fn:hover {
    color: var(--cor-primaria);
}

.comment-date {
    font-size: 0.9rem;
    color: var(--cor-texto-claro);
    margin-top: 0.25rem;
}

.comment-date a {
    color: inherit;
    text-decoration: none;
}

.comment-date a:hover {
    color: var(--cor-primaria);
}

.comment-awaiting-moderation {
    background: #fef3cd;
    color: #664d03;
    padding: 0.5rem;
    border-radius: 4px;
    font-size: 0.9rem;
    display: block;
    margin-top: 0.5rem;
}

.comment-content {
    color: var(--cor-texto);
    line-height: 1.6;
    margin-bottom: 1rem;
}

.comment-content p {
    margin-bottom: 1rem;
}

.comment-content p:last-child {
    margin-bottom: 0;
}

.comment-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.comment-actions .reply a,
.comment-actions .edit-link a {
    color: var(--cor-primaria);
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 500;
}

.comment-actions .reply a:hover,
.comment-actions .edit-link a:hover {
    color: var(--cor-accent);
}

.comment-navigation {
    margin: 2rem 0;
}

.comment-navigation .nav-links {
    display: flex;
    justify-content: space-between;
}

.comment-navigation a {
    color: var(--cor-primaria);
    text-decoration: none;
    padding: 0.5rem 1rem;
    border: 1px solid var(--cor-borda);
    border-radius: 4px;
    transition: all 0.3s ease;
}

.comment-navigation a:hover {
    background: var(--cor-primaria);
    color: white;
}

.no-comments {
    background: var(--cor-fundo-claro);
    padding: 1rem;
    border-radius: 4px;
    color: var(--cor-texto-claro);
    text-align: center;
    font-style: italic;
}

/* Formulário de comentário */
.comment-respond {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--cor-borda);
}

.comment-reply-title {
    color: var(--cor-texto);
    font-size: 1.25rem;
    margin-bottom: 1.5rem;
}

.comment-reply-title small a {
    color: var(--cor-primaria);
    text-decoration: none;
    font-size: 0.8em;
    margin-left: 1rem;
}

.comment-form {
    max-width: 600px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--cor-texto);
}

.form-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--cor-borda);
    border-radius: 4px;
    font-size: 1rem;
    font-family: inherit;
    transition: border-color 0.3s ease;
}

.form-input:focus {
    outline: none;
    border-color: var(--cor-primaria);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.comment-form-comment textarea {
    resize: vertical;
    min-height: 120px;
}

.form-submit {
    margin-top: 1rem;
}

/* Responsive */
@media (max-width: 768px) {
    .comment-item .comment-item {
        margin-left: 1rem;
    }
    
    .comment-author {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .comment-navigation .nav-links {
        flex-direction: column;
        gap: 1rem;
    }
}
</style>