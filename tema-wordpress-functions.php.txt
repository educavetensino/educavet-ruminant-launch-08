<?php
/**
 * Funções do tema
 */

// Evitar acesso direto
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Configuração do tema
 */
function tema_setup() {
    // Suporte a title-tag
    add_theme_support('title-tag');
    
    // Suporte a imagens destacadas
    add_theme_support('post-thumbnails');
    
    // Suporte a HTML5
    add_theme_support('html5', array(
        'search-form',
        'comment-form',
        'comment-list',
        'gallery',
        'caption',
    ));
    
    // Suporte a feeds automáticos
    add_theme_support('automatic-feed-links');
    
    // Suporte a logo personalizado
    add_theme_support('custom-logo', array(
        'height'      => 250,
        'width'       => 250,
        'flex-width'  => true,
        'flex-height' => true,
    ));
    
    // Registrar menus de navegação
    register_nav_menus(array(
        'primary' => 'Menu Principal',
        'footer'  => 'Menu do Rodapé',
    ));
    
    // Tamanhos de imagem personalizados
    add_image_size('post-thumbnail-large', 800, 400, true);
    add_image_size('post-thumbnail-medium', 400, 200, true);
}
add_action('after_setup_theme', 'tema_setup');

/**
 * Enfileirar scripts e estilos
 */
function tema_scripts() {
    // Estilo principal
    wp_enqueue_style('tema-style', get_stylesheet_uri(), array(), '1.0.0');
    
    // Google Fonts
    wp_enqueue_style('google-fonts', 'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap', false);
    
    // Font Awesome
    wp_enqueue_style('font-awesome', 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css', array(), '6.0.0');
    
    // Script principal
    wp_enqueue_script('tema-script', get_template_directory_uri() . '/js/script.js', array('jquery'), '1.0.0', true);
    
    // Script de comentários
    if (is_singular() && comments_open() && get_option('thread_comments')) {
        wp_enqueue_script('comment-reply');
    }
}
add_action('wp_enqueue_scripts', 'tema_scripts');

/**
 * Registrar áreas de widgets
 */
function tema_widgets_init() {
    register_sidebar(array(
        'name'          => 'Sidebar Principal',
        'id'            => 'sidebar-1',
        'description'   => 'Widgets da sidebar principal',
        'before_widget' => '<div id="%1$s" class="widget %2$s">',
        'after_widget'  => '</div>',
        'before_title'  => '<h3 class="widget-title">',
        'after_title'   => '</h3>',
    ));
    
    register_sidebar(array(
        'name'          => 'Footer 1',
        'id'            => 'footer-1',
        'description'   => 'Primeira coluna do rodapé',
        'before_widget' => '<div id="%1$s" class="footer-widget %2$s">',
        'after_widget'  => '</div>',
        'before_title'  => '<h3 class="widget-title">',
        'after_title'   => '</h3>',
    ));
    
    register_sidebar(array(
        'name'          => 'Footer 2',
        'id'            => 'footer-2',
        'description'   => 'Segunda coluna do rodapé',
        'before_widget' => '<div id="%1$s" class="footer-widget %2$s">',
        'after_widget'  => '</div>',
        'before_title'  => '<h3 class="widget-title">',
        'after_title'   => '</h3>',
    ));
    
    register_sidebar(array(
        'name'          => 'Footer 3',
        'id'            => 'footer-3',
        'description'   => 'Terceira coluna do rodapé',
        'before_widget' => '<div id="%1$s" class="footer-widget %2$s">',
        'after_widget'  => '</div>',
        'before_title'  => '<h3 class="widget-title">',
        'after_title'   => '</h3>',
    ));
}
add_action('widgets_init', 'tema_widgets_init');

/**
 * Customizar excerpt
 */
function tema_custom_excerpt_length($length) {
    return 30;
}
add_filter('excerpt_length', 'tema_custom_excerpt_length', 999);

function tema_custom_excerpt_more($more) {
    return '...';
}
add_filter('excerpt_more', 'tema_custom_excerpt_more');

/**
 * Adicionar classes ao body
 */
function tema_body_classes($classes) {
    if (!is_singular()) {
        $classes[] = 'hfeed';
    }
    
    if (is_home() || is_archive()) {
        $classes[] = 'blog-layout';
    }
    
    return $classes;
}
add_filter('body_class', 'tema_body_classes');

/**
 * Configurações do Customizer
 */
function tema_customize_register($wp_customize) {
    // Seção de cores
    $wp_customize->add_section('tema_colors', array(
        'title'    => 'Cores do Tema',
        'priority' => 30,
    ));
    
    // Cor primária
    $wp_customize->add_setting('tema_primary_color', array(
        'default'           => '#2563eb',
        'sanitize_callback' => 'sanitize_hex_color',
    ));
    
    $wp_customize->add_control(new WP_Customize_Color_Control($wp_customize, 'tema_primary_color', array(
        'label'    => 'Cor Primária',
        'section'  => 'tema_colors',
        'settings' => 'tema_primary_color',
    )));
    
    // Cor de destaque
    $wp_customize->add_setting('tema_accent_color', array(
        'default'           => '#f59e0b',
        'sanitize_callback' => 'sanitize_hex_color',
    ));
    
    $wp_customize->add_control(new WP_Customize_Color_Control($wp_customize, 'tema_accent_color', array(
        'label'    => 'Cor de Destaque',
        'section'  => 'tema_colors',
        'settings' => 'tema_accent_color',
    )));
}
add_action('customize_register', 'tema_customize_register');

/**
 * Aplicar cores personalizadas
 */
function tema_customizer_css() {
    $primary_color = get_theme_mod('tema_primary_color', '#2563eb');
    $accent_color = get_theme_mod('tema_accent_color', '#f59e0b');
    
    echo '<style type="text/css">';
    echo ':root { --cor-primaria: ' . esc_attr($primary_color) . '; }';
    echo ':root { --cor-accent: ' . esc_attr($accent_color) . '; }';
    echo '</style>';
}
add_action('wp_head', 'tema_customizer_css');

/**
 * Segurança - Remover informações desnecessárias
 */
remove_action('wp_head', 'wp_generator');
remove_action('wp_head', 'wlwmanifest_link');
remove_action('wp_head', 'rsd_link');

/**
 * Otimização - Remover emojis se não necessário
 */
function tema_disable_emojis() {
    remove_action('wp_head', 'print_emoji_detection_script', 7);
    remove_action('admin_print_scripts', 'print_emoji_detection_script');
    remove_action('wp_print_styles', 'print_emoji_styles');
    remove_action('admin_print_styles', 'print_emoji_styles');
}
add_action('init', 'tema_disable_emojis');

/**
 * Função para exibir breadcrumbs
 */
function tema_breadcrumbs() {
    if (!is_home() && !is_front_page()) {
        echo '<div class="breadcrumbs">';
        echo '<a href="' . home_url() . '">Início</a>';
        
        if (is_category() || is_single()) {
            echo ' > ';
            the_category(' > ');
            if (is_single()) {
                echo ' > ';
                the_title();
            }
        } elseif (is_page()) {
            echo ' > ';
            the_title();
        }
        
        echo '</div>';
    }
}

/**
 * Função para contar visualizações de posts
 */
function tema_set_post_views($postID) {
    $count_key = 'post_views_count';
    $count = get_post_meta($postID, $count_key, true);
    if($count == '') {
        $count = 0;
        delete_post_meta($postID, $count_key);
        add_post_meta($postID, $count_key, '0');
    } else {
        $count++;
        update_post_meta($postID, $count_key, $count);
    }
}

function tema_get_post_views($postID) {
    $count_key = 'post_views_count';
    $count = get_post_meta($postID, $count_key, true);
    if($count == '') {
        delete_post_meta($postID, $count_key);
        add_post_meta($postID, $count_key, '0');
        return "0 visualizações";
    }
    return $count . ' visualizações';
}

/**
 * Hook para limpar cache quando necessário
 */
function tema_clear_cache() {
    // Adicionar lógica de limpeza de cache se necessário
}
add_action('save_post', 'tema_clear_cache');
add_action('customize_save_after', 'tema_clear_cache');